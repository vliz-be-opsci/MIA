{"version":3,"file":"MediatorCombineArray.js","sourceRoot":"","sources":["MediatorCombineArray.ts"],"names":[],"mappings":";;;AACA,yCAA0C;AAE1C;;;;GAIG;AACH,MAAa,oBAKX,SAAQ,eAAoB;IAK5B,YAAmB,IAA2C;QAC5D,KAAK,CAAC,IAAI,CAAC,CAAC;QACZ,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,cAAc,EAAE,CAAC;IACxC,CAAC;IAEe,KAAK,CAAC,OAAO,CAAC,MAAS;QACrC,IAAI,WAAsC,CAAC;QAC3C,IAAI,CAAC;YACH,WAAW,GAAG,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;QACrC,CAAC;QAAC,MAAM,CAAC;YACP,WAAW,GAAG,EAAE,CAAC;QACnB,CAAC;QAED,IAAI,IAAI,CAAC,YAAY,EAAE,CAAC;YACtB,MAAM,YAAY,GAA8B,EAAE,CAAC;YACnD,KAAK,MAAM,MAAM,IAAI,WAAW,EAAE,CAAC;gBACjC,IAAI,CAAC;oBACH,MAAM,MAAM,CAAC,KAAK,CAAC;oBACnB,YAAY,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;gBAC5B,CAAC;gBAAC,MAAM,CAAC;oBACP,gBAAgB;gBAClB,CAAC;YACH,CAAC;YACD,WAAW,GAAG,YAAY,CAAC;QAC7B,CAAC;QAED,wBAAwB;QACxB,MAAM,OAAO,CAAC,GAAG,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC,EAAE,KAAK,EAAE,EAAE,EAAE,CAAC,KAAK,CAAC,CAAC,CAAC;QAEzD,4BAA4B;QAC5B,MAAM,OAAO,GAAQ,MAAM,OAAO,CAAC,GAAG,CAAC,WAAW,CAAC,GAAG,CAAC,MAAM,CAAC,EAAE,CAAC,MAAM,CAAC,KAAK,CAAC,aAAa,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;QAEtG,+BAA+B;QAC/B,OAAO,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC;IAChC,CAAC;IAEkB,WAAW;QAC5B,MAAM,IAAI,KAAK,CAAC,uBAAuB,CAAC,CAAC;IAC3C,CAAC;IAES,cAAc;QACtB,OAAO,CAAC,OAAY,EAAE,EAAE;YACtB,MAAM,IAAI,GAAQ,EAAE,CAAC;YACrB,KAAK,MAAM,KAAK,IAAI,IAAI,CAAC,MAAM,EAAE,CAAC;gBAChC,IAAI,CAAC,KAAK,CAAC,GAAG,EAAE,CAAC;gBACjB,iDAAiD;gBACjD,KAAK,MAAM,KAAK,IAAI,CAAC,EAAE,CAAC,CAAC,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC,MAAW,EAAE,EAAE,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC,EAAE,CAAC;oBAC7E,IAAI,KAAK,EAAE,CAAC;wBACV,IAAI,CAAC,KAAK,CAAC,CAAC,IAAI,CAAC,GAAG,KAAK,CAAC,CAAC;oBAC7B,CAAC;gBACH,CAAC;YACH,CAAC;YACD,OAAO,IAAI,CAAC;QACd,CAAC,CAAC;IACJ,CAAC;CACF;AAjED,oDAiEC","sourcesContent":["import type { Actor, IAction, IActorOutput, IActorReply, IActorTest, IMediatorArgs } from '@comunica/core';\nimport { Mediator } from '@comunica/core';\n\n/**\n * A comunica mediator that concatenates an array of all actor results.\n *\n * The actors that are registered first will appear earlier in the array.\n */\nexport class MediatorCombineArray<\n  A extends Actor<I, T, O>,\nI extends IAction,\nT extends IActorTest,\nO extends IActorOutput,\n> extends Mediator<A, I, T, O> implements IMediatorCombineUnionArgs<A, I, T, O> {\n  public readonly filterErrors: boolean | undefined;\n  public readonly fields: string[];\n  public readonly combiner: (results: O[]) => O;\n\n  public constructor(args: IMediatorCombineUnionArgs<A, I, T, O>) {\n    super(args);\n    this.combiner = this.createCombiner();\n  }\n\n  public override async mediate(action: I): Promise<O> {\n    let testResults: IActorReply<A, I, T, O>[];\n    try {\n      testResults = this.publish(action);\n    } catch {\n      testResults = [];\n    }\n\n    if (this.filterErrors) {\n      const _testResults: IActorReply<A, I, T, O>[] = [];\n      for (const result of testResults) {\n        try {\n          await result.reply;\n          _testResults.push(result);\n        } catch {\n          // Ignore errors\n        }\n      }\n      testResults = _testResults;\n    }\n\n    // Delegate test errors.\n    await Promise.all(testResults.map(({ reply }) => reply));\n\n    // Run action on all actors.\n    const results: O[] = await Promise.all(testResults.map(result => result.actor.runObservable(action)));\n\n    // Return the combined results.\n    return this.combiner(results);\n  }\n\n  protected override mediateWith(): Promise<A> {\n    throw new Error('Method not supported.');\n  }\n\n  protected createCombiner(): (results: O[]) => O {\n    return (results: O[]) => {\n      const data: any = {};\n      for (const field of this.fields) {\n        data[field] = [];\n        // eslint-disable-next-line unicorn/prefer-spread\n        for (const value of [[]].concat(results.map((result: any) => result[field]))) {\n          if (value) {\n            data[field].push(...value);\n          }\n        }\n      }\n      return data;\n    };\n  }\n}\n\nexport interface IMediatorCombineUnionArgs<\n  A extends Actor<I, T, O>,\nI extends IAction,\nT extends IActorTest,\nO extends IActorOutput,\n> extends IMediatorArgs<A, I, T, O> {\n  /**\n   * If actors that throw test errors should be ignored\n   */\n  filterErrors?: boolean;\n  /**\n   * The field names of the test result fields over which must be mediated.\n   */\n  fields: string[];\n}\n"]}