{"version":3,"file":"ActorRdfJoinMultiBindSource.js","sourceRoot":"","sources":["ActorRdfJoinMultiBindSource.ts"],"names":[],"mappings":"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","sourcesContent":["import { ActorQueryOperation } from '@comunica/bus-query-operation';\nimport type { IActionRdfJoin, IActorRdfJoinArgs, IActorRdfJoinOutputInner } from '@comunica/bus-rdf-join';\nimport { ActorRdfJoin, ChunkedIterator } from '@comunica/bus-rdf-join';\nimport type { MediatorRdfJoinEntriesSort } from '@comunica/bus-rdf-join-entries-sort';\nimport type { IMediatorTypeJoinCoefficients } from '@comunica/mediatortype-join-coefficients';\nimport type {\n  IJoinEntryWithMetadata,\n  IQueryOperationResultBindings,\n  IQuerySourceWrapper,\n  MetadataBindings,\n  IActionContext,\n} from '@comunica/types';\nimport type * as RDF from '@rdfjs/types';\nimport type { AsyncIterator } from 'asynciterator';\nimport { UnionIterator } from 'asynciterator';\nimport type { Algebra } from 'sparqlalgebrajs';\nimport { Factory } from 'sparqlalgebrajs';\n\nconst AF = new Factory();\n\n/**\n * A comunica Inner Multi Bind Source RDF Join Actor.\n */\nexport class ActorRdfJoinMultiBindSource extends ActorRdfJoin {\n  public readonly selectivityModifier: number;\n  public readonly blockSize: number;\n  public readonly mediatorJoinEntriesSort: MediatorRdfJoinEntriesSort;\n\n  public constructor(args: IActorRdfJoinInnerMultiBindSourceArgs) {\n    super(args, {\n      logicalType: 'inner',\n      physicalName: 'bind-source',\n      canHandleUndefs: true,\n    });\n  }\n\n  public async getOutput(action: IActionRdfJoin): Promise<IActorRdfJoinOutputInner> {\n    // Order the entries so we can pick the first one (usually the one with the lowest cardinality)\n    const entriesUnsorted = await ActorRdfJoin.getEntriesWithMetadatas(action.entries);\n    const entries = await this.sortJoinEntries(entriesUnsorted, action.context);\n\n    this.logDebug(\n      action.context,\n      'First entry for Bind Join Source: ',\n      () => ({ entry: entries[0].operation, metadata: entries[0].metadata }),\n    );\n\n    // Close the non-smallest streams\n    for (const [ i, element ] of entries.entries()) {\n      if (i !== 0) {\n        element.output.bindingsStream.close();\n      }\n    }\n\n    // Take the stream with the lowest cardinality\n    const smallestStream: IQueryOperationResultBindings = entries[0].output;\n    const smallestMetadata = entries[0].metadata;\n    const remainingEntries = [ ...entries ];\n    remainingEntries.splice(0, 1);\n\n    // Get source for remaining entries (guaranteed thanks to prior check in getJoinCoefficients())\n    const sourceWrapper: IQuerySourceWrapper = ActorQueryOperation.getOperationSource(remainingEntries[0].operation)!;\n\n    // Determine the operation to pass\n    const operation = this.createOperationFromEntries(remainingEntries);\n\n    // Slice the smallest stream into chunks according to the block size, so we avoid blocking too long.\n    const chunkedStreams: AsyncIterator<AsyncIterator<RDF.Bindings>> = new ChunkedIterator(\n      smallestStream.bindingsStream,\n      this.blockSize,\n      { autoStart: false },\n    );\n\n    // For each chunk, pass the query and the bindings to the source for execution\n    const bindingsStream = new UnionIterator(chunkedStreams.map(chunk => sourceWrapper.source.queryBindings(\n      operation,\n      sourceWrapper.context ? action.context.merge(sourceWrapper.context) : action.context,\n      { joinBindings: { bindings: chunk, metadata: smallestMetadata }},\n    )));\n\n    return {\n      result: {\n        type: 'bindings',\n        bindingsStream,\n        metadata: () => this.constructResultMetadata(entries, entries.map(entry => entry.metadata), action.context),\n      },\n      physicalPlanMetadata: {\n        bindIndex: entriesUnsorted.indexOf(entries[0]),\n      },\n    };\n  }\n\n  protected async sortJoinEntries(\n    entries: IJoinEntryWithMetadata[],\n    context: IActionContext,\n  ): Promise<IJoinEntryWithMetadata[]> {\n    entries = await ActorRdfJoin.sortJoinEntries(this.mediatorJoinEntriesSort, entries, context);\n\n    // Prioritize entries with modified operations, so these are not re-executed\n    entries = entries.sort((entryLeft, entryRight) => {\n      if (entryLeft.operationModified && !entryRight.operationModified) {\n        return -1;\n      }\n      return 0;\n    });\n\n    return entries;\n  }\n\n  public async getJoinCoefficients(\n    action: IActionRdfJoin,\n    metadatas: MetadataBindings[],\n  ): Promise<IMediatorTypeJoinCoefficients> {\n    // Order the entries so we can pick the first one (usually the one with the lowest cardinality)\n    const entries = await this.sortJoinEntries(action.entries\n      .map((entry, i) => ({ ...entry, metadata: metadatas[i] })), action.context);\n    metadatas = entries.map(entry => entry.metadata);\n\n    const requestInitialTimes = ActorRdfJoin.getRequestInitialTimes(metadatas);\n    const requestItemTimes = ActorRdfJoin.getRequestItemTimes(metadatas);\n\n    // Determine first stream and remaining ones\n    const remainingEntries = [ ...entries ];\n    const remainingRequestInitialTimes = [ ...requestInitialTimes ];\n    const remainingRequestItemTimes = [ ...requestItemTimes ];\n    remainingEntries.splice(0, 1);\n    remainingRequestInitialTimes.splice(0, 1);\n    remainingRequestItemTimes.splice(0, 1);\n\n    // Reject binding on operations without sources\n    const sources = remainingEntries.map(entry => ActorQueryOperation.getOperationSource(entry.operation));\n    if (sources.some(source => !source)) {\n      throw new Error(`Actor ${this.name} can not bind on remaining operations without source annotation`);\n    }\n\n    // Reject binding on operations with un-equal sources\n    if (sources.some(source => source !== sources[0])) {\n      throw new Error(`Actor ${this.name} can not bind on remaining operations with non-equal source annotation`);\n    }\n\n    // Reject if the source can not handle bindings\n    const sourceWrapper: IQuerySourceWrapper = sources[0]!;\n    const testingOperation = this.createOperationFromEntries(remainingEntries);\n    const selectorShape = await sourceWrapper.source.getSelectorShape(action.context);\n    if (!ActorQueryOperation\n      .doesShapeAcceptOperation(selectorShape, testingOperation, { joinBindings: true })) {\n      throw new Error(`Actor ${this.name} detected a source that can not handle passing down join bindings`);\n    }\n\n    // Determine selectivities of smallest entry with all other entries\n    const selectivities = await Promise.all(remainingEntries\n      .map(async entry => (await this.mediatorJoinSelectivity.mediate({\n        entries: [ entries[0], entry ],\n        context: action.context,\n      })).selectivity * this.selectivityModifier));\n\n    // Determine coefficients for remaining entries\n    const cardinalityRemaining = remainingEntries\n      .map((entry, i) => entry.metadata.cardinality.value * selectivities[i])\n      .reduce((sum, element) => sum + element, 0);\n\n    return {\n      iterations: 1,\n      persistedItems: metadatas[0].cardinality.value,\n      blockingItems: metadatas[0].cardinality.value,\n      requestTime: requestInitialTimes[0] + metadatas[0].cardinality.value * requestItemTimes[0] +\n        requestInitialTimes[1] + cardinalityRemaining * requestItemTimes[1],\n    };\n  }\n\n  public createOperationFromEntries(remainingEntries: IJoinEntryWithMetadata[]): Algebra.Operation {\n    if (remainingEntries.length === 1) {\n      return remainingEntries[0].operation;\n    }\n    return AF.createJoin(remainingEntries.map(entry => entry.operation), true);\n  }\n}\n\nexport interface IActorRdfJoinInnerMultiBindSourceArgs extends IActorRdfJoinArgs {\n  /**\n   * Multiplier for selectivity values\n   * @range {double}\n   * @default {0.0001}\n   */\n  selectivityModifier: number;\n  /**\n   * The maximum amount of bindings to send to the source per block.\n   * @default {16}\n   */\n  blockSize: number;\n  /**\n   * The join entries sort mediator\n   */\n  mediatorJoinEntriesSort: MediatorRdfJoinEntriesSort;\n}\n"]}