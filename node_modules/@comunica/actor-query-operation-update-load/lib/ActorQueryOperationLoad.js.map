{"version":3,"file":"ActorQueryOperationLoad.js","sourceRoot":"","sources":["ActorQueryOperationLoad.ts"],"names":[],"mappings":";;;AACA,uEAAsG;AAGtG,+DAA0D;AAG1D,uDAA+C;AAE/C,qDAA0C;AAE1C,MAAM,EAAE,GAAG,IAAI,8BAAW,EAAE,CAAC;AAE7B;;;GAGG;AACH,MAAa,uBAAwB,SAAQ,sDAA8C;IAOzF,YAAmB,IAAkC;QACnD,KAAK,CAAC,IAAI,EAAE,MAAM,CAAC,CAAC;QACpB,IAAI,CAAC,OAAO,GAAG,IAAI,yBAAO,EAAE,CAAC;IAC/B,CAAC;IAEM,KAAK,CAAC,aAAa,CAAC,SAAuB,EAAE,OAAuB;QACzE,yCAAmB,CAAC,eAAe,CAAC,OAAO,CAAC,CAAC;QAC7C,OAAO,IAAI,CAAC;IACd,CAAC;IAEM,KAAK,CAAC,YAAY,CAAC,SAAuB,EAAE,OAAuB;QAExE,yBAAyB;QACzB,IAAI,UAAU,GAAG,OAAO,CAAC;QACzB,IAAI,SAAS,CAAC,MAAM,EAAE,CAAC;YACrB,UAAU,GAAG,UAAU,CAAC,GAAG,CAAC,+BAAa,CAAC,OAAO,EAAE,IAAI,CAAC,CAAC;QAC3D,CAAC;QACD,MAAM,EAAE,WAAW,EAAE,GAAG,MAAM,IAAI,CAAC,2BAA2B,CAAC,OAAO,CAAC;YACrE,uBAAuB,EAAE,EAAE,KAAK,EAAE,SAAS,CAAC,MAAM,CAAC,KAAK,EAAE;YAC1D,OAAO,EAAE,UAAU;SACpB,CAAC,CAAC;QAEH,6CAA6C;QAC7C,MAAM,MAAM,GAAG,uBAAuB,CAAC,YAAY,CAAC,MAAM,IAAI,CAAC,sBAAsB,CAAC,OAAO,CAAC;YAC5F,SAAS,EAAE,IAAI,CAAC,OAAO,CAAC,eAAe,CACrC,yCAAmB,CAAC,qBAAqB,CACvC,IAAI,CAAC,OAAO,CAAC,aAAa,CAAC,EAAE,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,EAAE,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,EAAE,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC,EAChF,WAAW,CACZ,EACD,CAAE,IAAI,CAAC,OAAO,CAAC,aAAa,CAAC,EAAE,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,EAAE,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,EAAE,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC,CAAE,CACrF;YACD,OAAO,EAAE,UAAU;SACpB,CAAC,CAAC,CAAC;QAEJ,kCAAkC;QAClC,IAAI,UAAU,GAAG,MAAM,CAAC,UAAU,CAAC;QACnC,IAAI,SAAS,CAAC,WAAW,EAAE,CAAC;YAC1B,UAAU,GAAG,UAAU,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC,EAAE,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,SAAS,EAAE,IAAI,CAAC,MAAM,EAAE,SAAS,CAAC,WAAW,CAAC,CAAC,CAAC;QACjH,CAAC;QAED,qBAAqB;QACrB,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAI,CAAC,mBAAmB,CAAC,OAAO,CAAC;YACzD,gBAAgB,EAAE,UAAU;YAC5B,OAAO;SACR,CAAC,CAAC;QAEH,OAAO;YACL,IAAI,EAAE,MAAM;YACZ,OAAO;SACR,CAAC;IACJ,CAAC;CACF;AA1DD,0DA0DC","sourcesContent":["import type { IActorQueryOperationTypedMediatedArgs } from '@comunica/bus-query-operation';\nimport { ActorQueryOperation, ActorQueryOperationTypedMediated } from '@comunica/bus-query-operation';\nimport type { MediatorQuerySourceIdentify } from '@comunica/bus-query-source-identify';\nimport type { MediatorRdfUpdateQuads } from '@comunica/bus-rdf-update-quads';\nimport { KeysInitQuery } from '@comunica/context-entries';\nimport type { IActorTest } from '@comunica/core';\nimport type { IActionContext, IQueryOperationResult } from '@comunica/types';\nimport { DataFactory } from 'rdf-data-factory';\nimport type { Algebra } from 'sparqlalgebrajs';\nimport { Factory } from 'sparqlalgebrajs';\n\nconst DF = new DataFactory();\n\n/**\n * A [Query Operation](https://github.com/comunica/comunica/tree/master/packages/bus-query-operation) actor\n * that handles SPARQL load operations.\n */\nexport class ActorQueryOperationLoad extends ActorQueryOperationTypedMediated<Algebra.Load> {\n  public readonly mediatorUpdateQuads: MediatorRdfUpdateQuads;\n  public readonly mediatorQuerySourceIdentify: MediatorQuerySourceIdentify;\n\n  private readonly factory: Factory;\n  private readonly constructOperation: Algebra.Construct;\n\n  public constructor(args: IActorQueryOperationLoadArgs) {\n    super(args, 'load');\n    this.factory = new Factory();\n  }\n\n  public async testOperation(operation: Algebra.Load, context: IActionContext): Promise<IActorTest> {\n    ActorQueryOperation.throwOnReadOnly(context);\n    return true;\n  }\n\n  public async runOperation(operation: Algebra.Load, context: IActionContext):\n  Promise<IQueryOperationResult> {\n    // Determine query source\n    let subContext = context;\n    if (operation.silent) {\n      subContext = subContext.set(KeysInitQuery.lenient, true);\n    }\n    const { querySource } = await this.mediatorQuerySourceIdentify.mediate({\n      querySourceUnidentified: { value: operation.source.value },\n      context: subContext,\n    });\n\n    // Create CONSTRUCT query on the given source\n    const output = ActorQueryOperationLoad.getSafeQuads(await this.mediatorQueryOperation.mediate({\n      operation: this.factory.createConstruct(\n        ActorQueryOperation.assignOperationSource(\n          this.factory.createPattern(DF.variable('s'), DF.variable('p'), DF.variable('o')),\n          querySource,\n        ),\n        [ this.factory.createPattern(DF.variable('s'), DF.variable('p'), DF.variable('o')) ],\n      ),\n      context: subContext,\n    }));\n\n    // Determine quad stream to insert\n    let quadStream = output.quadStream;\n    if (operation.destination) {\n      quadStream = quadStream.map(quad => DF.quad(quad.subject, quad.predicate, quad.object, operation.destination));\n    }\n\n    // Insert quad stream\n    const { execute } = await this.mediatorUpdateQuads.mediate({\n      quadStreamInsert: quadStream,\n      context,\n    });\n\n    return {\n      type: 'void',\n      execute,\n    };\n  }\n}\n\nexport interface IActorQueryOperationLoadArgs extends IActorQueryOperationTypedMediatedArgs {\n  /**\n   * The RDF Update Quads mediator\n   */\n  mediatorUpdateQuads: MediatorRdfUpdateQuads;\n  /**\n   * Mediator for identifying load sources.\n   */\n  mediatorQuerySourceIdentify: MediatorQuerySourceIdentify;\n}\n"]}