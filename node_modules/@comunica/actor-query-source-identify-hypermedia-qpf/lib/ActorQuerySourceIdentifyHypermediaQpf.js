"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ActorQuerySourceIdentifyHypermediaQpf = void 0;
const bindings_factory_1 = require("@comunica/bindings-factory");
const bus_query_source_identify_hypermedia_1 = require("@comunica/bus-query-source-identify-hypermedia");
const QuerySourceQpf_1 = require("./QuerySourceQpf");
/**
 * A comunica QPF Query Source Identify Hypermedia Actor.
 */
class ActorQuerySourceIdentifyHypermediaQpf extends bus_query_source_identify_hypermedia_1.ActorQuerySourceIdentifyHypermedia {
    constructor(args) {
        super(args, 'qpf');
    }
    async test(action) {
        if (action.forceSourceType && (action.forceSourceType !== 'qpf' && action.forceSourceType !== 'brtpf')) {
            throw new Error(`Actor ${this.name} is not able to handle source type ${action.forceSourceType}.`);
        }
        return this.testMetadata(action);
    }
    async testMetadata(action) {
        const { searchForm } = await this.createSource(action.url, action.metadata, action.context, action.forceSourceType === 'brtpf');
        if (action.handledDatasets && action.handledDatasets[searchForm.dataset]) {
            throw new Error(`Actor ${this.name} can only be applied for the first page of a QPF dataset.`);
        }
        return { filterFactor: 1 };
    }
    /**
     * Look for the search form
     * @param {IActionRdfResolveHypermedia} action the metadata to look for the form.
     * @return {Promise<IActorRdfResolveHypermediaOutput>} A promise resolving to a hypermedia form.
     */
    async run(action) {
        this.logInfo(action.context, `Identified as qpf source: ${action.url}`);
        const source = await this.createSource(action.url, action.metadata, action.context, action.forceSourceType === 'brtpf', action.quads);
        return { source, dataset: source.searchForm.dataset };
    }
    async createSource(url, metadata, context, bindingsRestricted, quads) {
        return new QuerySourceQpf_1.QuerySourceQpf(this.mediatorMetadata, this.mediatorMetadataExtract, this.mediatorDereferenceRdf, await bindings_factory_1.BindingsFactory.create(this.mediatorMergeBindingsContext, context), this.subjectUri, this.predicateUri, this.objectUri, this.graphUri, url, metadata, bindingsRestricted, quads);
    }
}
exports.ActorQuerySourceIdentifyHypermediaQpf = ActorQuerySourceIdentifyHypermediaQpf;
//# sourceMappingURL=ActorQuerySourceIdentifyHypermediaQpf.js.map